# 积分系统实现方案

## 需求概述

1. 用户登录后默认获取 10 个 credits，在页面显示剩余 credits
2. 目前只有每月 19 美元的订阅套餐，订阅成功后获取 100 个 credits
3. 生成一张图片消耗一个 credits，当用户 credits 小于 1 的时候提示订阅
4. 订阅后获取的 credits 有效期为一个月，到期后数量清零，初始获取的 10 个无期限
5. 支持用户在 credits 未到期情况下继续订阅，除初始 10 个以外所有 credits 过期时间重置为一个月

## 数据库设计

### 1. user_credits 表（用户积分）

```sql
CREATE TABLE user_credits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  total_credits INTEGER NOT NULL DEFAULT 0,           -- 总积分
  free_credits INTEGER NOT NULL DEFAULT 10,           -- 免费积分（永不过期）
  subscription_credits INTEGER NOT NULL DEFAULT 0,    -- 订阅积分（会过期）
  subscription_expires_at TIMESTAMPTZ,                -- 订阅积分过期时间
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

CREATE INDEX idx_user_credits_user_id ON user_credits(user_id);
CREATE INDEX idx_user_credits_expires ON user_credits(subscription_expires_at);
```

**字段说明：**
- `total_credits`: 总积分 = free_credits + subscription_credits
- `free_credits`: 初始赠送的 10 个积分，永不过期
- `subscription_credits`: 订阅获得的积分，会在 subscription_expires_at 时过期
- `subscription_expires_at`: 订阅积分的过期时间

### 2. credit_transactions 表（积分交易记录）

```sql
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  amount INTEGER NOT NULL,                            -- 积分变动数量（正数为增加，负数为减少）
  transaction_type VARCHAR(50) NOT NULL,              -- 交易类型：grant_initial, grant_subscription, consume, expire
  description TEXT,                                   -- 描述
  metadata JSONB,                                     -- 额外信息（如 paypal_order_id）
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_credit_transactions_user_id ON credit_transactions(user_id);
CREATE INDEX idx_credit_transactions_created ON credit_transactions(created_at);
```

### 3. subscriptions 表（订阅记录）

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  paypal_order_id VARCHAR(255) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  status VARCHAR(50) NOT NULL,                        -- 'active', 'expired', 'cancelled'
  credits_granted INTEGER NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_paypal_order ON subscriptions(paypal_order_id);
CREATE INDEX idx_subscriptions_expires ON subscriptions(expires_at);
```

### 4. 行级安全策略（RLS）

```sql
-- 启用 RLS
ALTER TABLE user_credits ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

-- 用户只能查看自己的积分
CREATE POLICY "Users can view own credits" ON user_credits
  FOR SELECT USING (auth.uid() = user_id);

-- 用户只能查看自己的交易记录
CREATE POLICY "Users can view own transactions" ON credit_transactions
  FOR SELECT USING (auth.uid() = user_id);

-- 用户只能查看自己的订阅
CREATE POLICY "Users can view own subscriptions" ON subscriptions
  FOR SELECT USING (auth.uid() = user_id);
```

## 实现步骤

### 阶段 1：数据库设置

**需要创建的文件：**
- `supabase/migrations/001_create_credits_system.sql`

**任务：**
1. 创建 Supabase 迁移文件包含三个表
2. 添加索引提升性能
3. 设置行级安全策略（RLS）
4. 在 Supabase 控制台执行迁移
5. 测试数据库结构

### 阶段 2：积分工具函数

在 `lib/credits/` 目录创建可复用的积分操作函数：

#### 1. get-user-credits.ts - 获取用户积分

```typescript
import { createClient } from '@/lib/supabase/server'

export async function getUserCredits(userId: string) {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('user_credits')
    .select('*')
    .eq('user_id', userId)
    .single()

  if (error) return { data: null, error }

  return { data, error: null }
}
```

#### 2. grant-initial-credits.ts - 赠送初始积分

```typescript
import { createClient } from '@/lib/supabase/server'

export async function grantInitialCredits(userId: string) {
  const supabase = await createClient()

  // 检查用户是否已有积分记录
  const { data: existing } = await supabase
    .from('user_credits')
    .select('id')
    .eq('user_id', userId)
    .single()

  if (existing) return { alreadyGranted: true }

  // 创建初始积分记录
  const { error: creditsError } = await supabase
    .from('user_credits')
    .insert({
      user_id: userId,
      total_credits: 10,
      free_credits: 10,
      subscription_credits: 0
    })

  if (creditsError) throw creditsError

  // 记录交易
  await supabase.from('credit_transactions').insert({
    user_id: userId,
    amount: 10,
    transaction_type: 'grant_initial',
    description: '初始免费积分'
  })

  return { granted: true, amount: 10 }
}
```

#### 3. grant-subscription-credits.ts - 赠送订阅积分

```typescript
import { createClient } from '@/lib/supabase/server'

export async function grantSubscriptionCredits(
  userId: string,
  paypalOrderId: string,
  amount: number
) {
  const supabase = await createClient()

  // 根据金额确定积分数量
  const creditsMap: Record<string, number> = {
    '19.00': 100,
    '29.00': 200,
    '49.00': 500
  }

  const creditsToGrant = creditsMap[amount.toFixed(2)] || 100
  const expiresAt = new Date()
  expiresAt.setMonth(expiresAt.getMonth() + 1)

  // 获取当前积分
  const { data: userCredits, error: fetchError } = await supabase
    .from('user_credits')
    .select('*')
    .eq('user_id', userId)
    .single()

  if (fetchError) throw fetchError

  // 更新积分
  const { error: updateError } = await supabase
    .from('user_credits')
    .update({
      total_credits: userCredits.total_credits + creditsToGrant,
      subscription_credits: userCredits.subscription_credits + creditsToGrant,
      subscription_expires_at: expiresAt.toISOString(),
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId)

  if (updateError) throw updateError

  // 创建订阅记录
  await supabase.from('subscriptions').insert({
    user_id: userId,
    paypal_order_id: paypalOrderId,
    amount,
    status: 'active',
    credits_granted: creditsToGrant,
    expires_at: expiresAt.toISOString()
  })

  // 记录交易
  await supabase.from('credit_transactions').insert({
    user_id: userId,
    amount: creditsToGrant,
    transaction_type: 'grant_subscription',
    description: `订阅积分 $${amount}`,
    metadata: { paypal_order_id: paypalOrderId }
  })

  return { granted: true, amount: creditsToGrant, expiresAt }
}
```

#### 4. consume-credits.ts - 消耗积分

```typescript
import { createClient } from '@/lib/supabase/server'

export async function consumeCredits(userId: string, amount: number = 1) {
  const supabase = await createClient()

  // 获取当前积分
  const { data: userCredits, error: fetchError } = await supabase
    .from('user_credits')
    .select('*')
    .eq('user_id', userId)
    .single()

  if (fetchError) throw fetchError
  if (!userCredits) throw new Error('用户积分记录不存在')

  // 检查积分是否充足
  if (userCredits.total_credits < amount) {
    return {
      success: false,
      error: 'insufficient_credits',
      remaining: userCredits.total_credits
    }
  }

  // 优先扣除订阅积分，再扣除免费积分
  let newSubscriptionCredits = userCredits.subscription_credits
  let newFreeCredits = userCredits.free_credits
  let remaining = amount

  if (newSubscriptionCredits >= remaining) {
    newSubscriptionCredits -= remaining
    remaining = 0
  } else {
    remaining -= newSubscriptionCredits
    newSubscriptionCredits = 0
    newFreeCredits -= remaining
  }

  // 更新积分
  const { error: updateError } = await supabase
    .from('user_credits')
    .update({
      total_credits: userCredits.total_credits - amount,
      subscription_credits: newSubscriptionCredits,
      free_credits: newFreeCredits,
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId)

  if (updateError) throw updateError

  // 记录交易
  await supabase.from('credit_transactions').insert({
    user_id: userId,
    amount: -amount,
    transaction_type: 'consume',
    description: '图片生成'
  })

  return {
    success: true,
    remaining: userCredits.total_credits - amount
  }
}
```

#### 5. handle-resubscription.ts - 处理重复订阅

```typescript
import { createClient } from '@/lib/supabase/server'

export async function handleResubscription(
  userId: string,
  paypalOrderId: string,
  amount: number
) {
  const supabase = await createClient()

  const { data: userCredits } = await supabase
    .from('user_credits')
    .select('*')
    .eq('user_id', userId)
    .single()

  if (!userCredits) throw new Error('用户积分记录不存在')

  // 计算新积分
  const creditsMap: Record<string, number> = {
    '19.00': 100,
    '29.00': 200,
    '49.00': 500
  }
  const newCredits = creditsMap[amount.toFixed(2)] || 100

  // 重置过期时间为当前时间 + 1 个月
  const newExpiresAt = new Date()
  newExpiresAt.setMonth(newExpiresAt.getMonth() + 1)

  // 保留免费积分，重置订阅积分
  const { error: updateError } = await supabase
    .from('user_credits')
    .update({
      total_credits: userCredits.free_credits + newCredits,
      subscription_credits: newCredits,
      subscription_expires_at: newExpiresAt.toISOString(),
      updated_at: new Date().toISOString()
    })
    .eq('user_id', userId)

  if (updateError) throw updateError

  // 创建新订阅记录
  await supabase.from('subscriptions').insert({
    user_id: userId,
    paypal_order_id: paypalOrderId,
    amount,
    status: 'active',
    credits_granted: newCredits,
    expires_at: newExpiresAt.toISOString()
  })

  // 记录交易
  await supabase.from('credit_transactions').insert({
    user_id: userId,
    amount: newCredits,
    transaction_type: 'grant_subscription',
    description: `重复订阅积分 $${amount}`,
    metadata: { paypal_order_id: paypalOrderId }
  })

  return { success: true, credits: newCredits, expiresAt: newExpiresAt }
}
```

### 阶段 3：初始积分集成

**需要修改的文件：** `middleware.ts`

在用户认证后检查是否有积分记录，如果没有则赠送初始积分。

```typescript
import { grantInitialCredits } from '@/lib/credits/grant-initial-credits'

// 在认证成功后添加
const { data: { user } } = await supabase.auth.getUser()
if (user) {
  try {
    await grantInitialCredits(user.id)
  } catch (error) {
    console.error('Failed to grant initial credits:', error)
  }
}
```

### 阶段 4：支付集成

**需要修改的文件：** `app/api/orders/[orderID]/capture/route.ts`

在 PayPal 支付成功后赠送积分。

```typescript
import { grantSubscriptionCredits } from '@/lib/credits/grant-subscription-credits'
import { handleResubscription } from '@/lib/credits/handle-resubscription'
import { getUserCredits } from '@/lib/credits/get-user-credits'

// 在支付捕获成功后（第 18 行之后）
const { data: userCredits } = await getUserCredits(user.id)

// 检查是否是重复订阅
if (userCredits && userCredits.subscription_credits > 0) {
  // 重复订阅，重置过期时间
  await handleResubscription(user.id, orderID, parseFloat(jsonResponse.purchase_units[0].amount.value))
} else {
  // 新订阅，赠送积分
  await grantSubscriptionCredits(user.id, orderID, parseFloat(jsonResponse.purchase_units[0].amount.value))
}
```

### 阶段 5：生成接口集成

**需要修改的文件：** `app/api/generate/route.ts`

在图片生成前检查和消耗积分（第 16 行之后）。

```typescript
import { consumeCredits } from '@/lib/credits/consume-credits'
import { getUserCredits } from '@/lib/credits/get-user-credits'

// 在认证检查之后添加
const { data: credits } = await getUserCredits(user.id)
if (!credits || credits.total_credits < 1) {
  return NextResponse.json(
    { error: 'insufficient_credits', remaining: credits?.total_credits || 0 },
    { status: 402 }
  )
}

// 消耗积分
const consumeResult = await consumeCredits(user.id, 1)
if (!consumeResult.success) {
  return NextResponse.json(
    { error: 'insufficient_credits', remaining: consumeResult.remaining },
    { status: 402 }
  )
}

// 继续执行现有生成逻辑...
```

### 阶段 6：UI 组件

#### 1. 创建积分显示组件

**需要创建的文件：** `components/credits-display.tsx`

```typescript
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { useRouter } from 'next/navigation'

export function CreditsDisplay() {
  const [credits, setCredits] = useState<number | null>(null)
  const [loading, setLoading] = useState(true)
  const supabase = createClient()
  const router = useRouter()

  useEffect(() => {
    async function fetchCredits() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return

      const { data } = await supabase
        .from('user_credits')
        .select('total_credits')
        .eq('user_id', user.id)
        .single()

      setCredits(data?.total_credits ?? 0)
      setLoading(false)
    }

    fetchCredits()

    // 订阅实时更新
    const channel = supabase
      .channel('credits-changes')
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'user_credits'
      }, (payload) => {
        setCredits(payload.new.total_credits)
      })
      .subscribe()

    return () => { channel.unsubscribe() }
  }, [])

  if (loading) return null

  return (
    <div className="flex items-center gap-3">
      <Badge variant={credits && credits > 0 ? 'default' : 'destructive'}>
        {credits ?? 0} Credits
      </Badge>
      {credits !== null && credits < 1 && (
        <Button
          size="sm"
          onClick={() => router.push('/pricing')}
        >
          获取积分
        </Button>
      )}
    </div>
  )
}
```

#### 2. 修改生成器组件

**需要修改的文件：** `components/generator-demo.tsx`

1. 在头部添加积分显示组件
2. 更新 `runGeneration()` 函数处理积分不足的情况

```typescript
import { CreditsDisplay } from '@/components/credits-display'
import { useToast } from '@/hooks/use-toast'

// 在组件中添加
const { toast } = useToast()

// 在 JSX 中添加积分显示（约第 196 行）
<CreditsDisplay />

// 更新 runGeneration 函数（约第 136 行）
const runGeneration = async () => {
  setGenerating(true)
  try {
    const payload = {
      prompt: prompt.trim(),
      references: mode === "image-to-image" ? referenceImages : [],
      model: "google/gemini-3-pro-image-preview",
    }

    const res = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })

    if (res.status === 402) {
      // 积分不足
      const err = await res.json()
      toast({
        title: "积分不足",
        description: "您需要积分来生成图片。订阅即可获得 100 个积分！",
        action: (
          <Button onClick={() => window.location.href = '/pricing'}>
            立即订阅
          </Button>
        )
      })
      return
    }

    // ... 继续现有逻辑
  } catch (error: any) {
    // ... 现有错误处理
  } finally {
    setGenerating(false)
  }
}
```

### 阶段 7：过期系统

#### 1. 创建定时任务端点

**需要创建的文件：** `app/api/cron/expire-credits/route.ts`

```typescript
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: Request) {
  // 验证定时任务密钥
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const supabase = await createClient()

  // 查找过期的订阅
  const { data: expiredUsers } = await supabase
    .from('user_credits')
    .select('*')
    .lt('subscription_expires_at', new Date().toISOString())
    .gt('subscription_credits', 0)

  if (!expiredUsers || expiredUsers.length === 0) {
    return NextResponse.json({ expired: 0 })
  }

  // 处理每个过期用户
  for (const user of expiredUsers) {
    const expiredAmount = user.subscription_credits

    await supabase
      .from('user_credits')
      .update({
        total_credits: user.free_credits,
        subscription_credits: 0,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', user.user_id)

    // 记录过期
    await supabase.from('credit_transactions').insert({
      user_id: user.user_id,
      amount: -expiredAmount,
      transaction_type: 'expire',
      description: '订阅积分已过期'
    })
  }

  return NextResponse.json({ expired: expiredUsers.length })
}
```

#### 2. 配置 Vercel 定时任务

**需要创建的文件：** `vercel.json`

```json
{
  "crons": [{
    "path": "/api/cron/expire-credits",
    "schedule": "0 0 * * *"
  }]
}
```

**环境变量：** 在 Vercel 项目设置中添加 `CRON_SECRET` 环境变量。

### 阶段 8：测试验证

1. 测试首次登录赠送 10 积分
2. 测试支付流程赠送 100 积分
3. 测试图片生成消耗 1 积分
4. 测试积分不足显示提示
5. 测试重复订阅重置过期时间
6. 测试过期定时任务
7. 验证 RLS 策略防止未授权访问

## 核心业务逻辑

### 积分消耗顺序

1. 优先扣除 `subscription_credits`（订阅积分）
2. 再扣除 `free_credits`（免费积分）
3. 免费积分（初始 10 个）永不过期

### 重复订阅行为

- 保持 `free_credits` 不变
- 重置 `subscription_credits` 为新数量（100）
- 重置 `subscription_expires_at` 为当前时间 + 1 个月
- 旧的订阅积分被替换，不是累加

### 过期机制

- 只有 `subscription_credits` 会过期
- 每天通过定时任务执行过期检查
- 免费积分永久保留

## 安全考虑

1. **服务端验证：** 所有积分操作仅在服务端执行
2. **RLS 策略：** 用户只能读取自己的积分
3. **竞态条件：** 使用数据库事务保证原子操作
4. **审计追踪：** 在 credit_transactions 表记录所有积分变动
5. **支付验证：** 赠送积分前验证 PayPal 支付
6. **定时任务保护：** 使用密钥保护定时任务端点

## 文件清单

### 需要创建的新文件

- `supabase/migrations/001_create_credits_system.sql`
- `lib/credits/get-user-credits.ts`
- `lib/credits/grant-initial-credits.ts`
- `lib/credits/grant-subscription-credits.ts`
- `lib/credits/consume-credits.ts`
- `lib/credits/handle-resubscription.ts`
- `components/credits-display.tsx`
- `app/api/cron/expire-credits/route.ts`
- `vercel.json`

### 需要修改的文件

- `middleware.ts` - 赠送初始积分
- `app/api/orders/[orderID]/capture/route.ts` - 赠送订阅积分
- `app/api/generate/route.ts` - 检查和消耗积分
- `components/generator-demo.tsx` - 显示积分和处理错误

## 环境变量

需要在 Vercel 项目设置中添加：
- `CRON_SECRET` - 定时任务端点保护密钥
